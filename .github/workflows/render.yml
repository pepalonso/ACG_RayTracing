name: Render Ray Tracing Scene

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Clean and configure CMake
        run: |
          rm -rf build
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release

      - name: Build project
        run: |
          cd build
          cmake --build . -j$(nproc)

      - name: Run Ray Tracer
        run: |
          cd build
          ./ACG || true
          echo "--- Checking output files ---"
          ls -lah output.* 2>/dev/null || echo "No output files found in build/"
          if [ -f output.bmp ]; then
            echo "BMP file size: $(stat -f%z output.bmp 2>/dev/null || stat -c%s output.bmp) bytes"
            file output.bmp || true
          else
            echo "ERROR: output.bmp was NOT created!"
          fi

      - name: Save rendered output to repo
        run: |
          # Create renders directory if it doesn't exist
          mkdir -p renders

          # Copy the output with timestamp
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          cp build/output.bmp renders/${TIMESTAMP}_output.bmp

          # Also keep a 'latest' version
          cp build/output.bmp renders/latest.bmp

          echo "âœ… Saved to renders/${TIMESTAMP}_output.bmp"
        if: always()

      - name: Commit and push renders
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add renders/
          git diff --staged --quiet || git commit -m "Add rendered output ${TIMESTAMP} [skip ci]" || echo "No changes to commit"
          git push || echo "Push failed, but continuing..."
        if: always()
        env:
          TIMESTAMP: ${{ github.run_number }}

      - name: Display render info
        run: |
          echo "âœ… Render complete!"
          echo "ğŸ“Š Output file size:"
          ls -lh build/output.bmp 2>/dev/null || echo "Output file not found"
          echo ""
          echo "ğŸ¨ Rendered image saved to renders/ folder in the repo"
          echo "   - Latest: renders/latest.bmp"
          echo "   - Timestamped: renders/[timestamp]_output.bmp"
